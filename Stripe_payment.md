# üí≥ Stripe Payment API Documentation - E-Learning Platform

## üìã Informaci√≥n General

**Base URL:** `http://localhost:8080`  
**Versi√≥n:** 1.0  
**Tipo de Autenticaci√≥n:** JWT (JSON Web Tokens)  
**Content-Type:** `application/json`  
**Proveedor de Pagos:** Stripe API v3  

## Comando para ejecutar backend en entorno de desarrollo
```bash
./mvnw spring-boot:run -Dspring-boot.run.profiles=dev
```

## üèóÔ∏è Arquitectura de Pagos

El sistema de pagos integra **Stripe** como proveedor de pagos y maneja el flujo completo desde la creaci√≥n de sesiones hasta la confirmaci√≥n de pagos mediante webhooks.

### Flujo de Pago Completo:
1. **Usuario selecciona curso** ‚Üí Frontend obtiene informaci√≥n del curso
2. **Crear sesi√≥n de pago** ‚Üí `POST /api/stripe/create-checkout-session`
3. **Redirigir a Stripe** ‚Üí Usuario completa el pago en Stripe Checkout
4. **Webhook confirmation** ‚Üí Stripe notifica el resultado via webhook
5. **Crear inscripci√≥n** ‚Üí Sistema crea autom√°ticamente la inscripci√≥n del usuario

---

## üéØ Endpoints de Stripe

### 1. Crear Sesi√≥n de Checkout
**Endpoint:** `POST /api/stripe/create-checkout-session`  
**Descripci√≥n:** Crea una sesi√≥n de pago en Stripe para un curso espec√≠fico  
**Acceso:** Todos los usuarios autenticados (STUDENT, INSTRUCTOR, ADMIN)  
**Autenticaci√≥n:** JWT Required  

#### Request Body:
```json
{
  "courseId": 1,
  "userId": 5,
  "successUrl": "https://miapp.com/payment/success",
  "cancelUrl": "https://miapp.com/payment/cancel"
}
```

#### Validaciones:
- **courseId:** Requerido, n√∫mero positivo, debe existir en la base de datos
- **userId:** Requerido, n√∫mero positivo, debe existir en la base de datos  
- **successUrl:** Opcional, URL de redirecci√≥n despu√©s del pago exitoso
- **cancelUrl:** Opcional, URL de redirecci√≥n si el usuario cancela

#### Headers Requeridos:
```
Authorization: Bearer {jwt_token}
Content-Type: application/json
Accept: application/json
```

#### Response Exitoso (200 OK):
```json
{
  "sessionId": "cs_test_a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0",
  "checkoutUrl": "https://checkout.stripe.com/c/pay/cs_test_a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0#fidkdWxOYHwn",
  "paymentSessionId": 123,
  "message": "Sesi√≥n de pago creada exitosamente"
}
```

#### Response de Error (400 Bad Request):
```json
{
  "sessionId": null,
  "checkoutUrl": null,
  "paymentSessionId": null,
  "message": "Error al crear sesi√≥n de pago: El curso no existe"
}
```

#### Response de Error (401 Unauthorized):
```json
{
  "message": "Token ausente, inv√°lido o expirado",
  "status": 401,
  "timestamp": "2025-01-01T10:00:00"
}
```

#### Response de Error (500 Internal Server Error):
```json
{
  "sessionId": null,
  "checkoutUrl": null,
  "paymentSessionId": null,
  "message": "Error interno del servidor"
}
```

#### Casos de Uso:
- ‚úÖ **Usuario quiere comprar un curso premium**
- ‚úÖ **Usuario ya inscrito quiere acceder nuevamente** (validaci√≥n autom√°tica)
- ‚ùå **Curso gratuito** (no requiere pago)
- ‚ùå **Usuario ya tiene acceso** (evita doble pago)

---

### 2. Webhook de Stripe
**Endpoint:** `POST /api/stripe/webhook`  
**Descripci√≥n:** Endpoint interno para recibir notificaciones de Stripe sobre el estado de los pagos  
**Acceso:** Solo Stripe (IP whitelisting recomendado en producci√≥n)  
**Autenticaci√≥n:** Stripe Signature Header  

#### Headers Requeridos:
```
Stripe-Signature: t=1640995200,v1=signature_hash
Content-Type: application/json
```

#### Request Body (Ejemplo de pago exitoso):
```json
{
  "id": "evt_1234567890",
  "object": "event",
  "type": "checkout.session.completed",
  "data": {
    "object": {
      "id": "cs_test_a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0",
      "payment_status": "paid",
      "metadata": {
        "courseId": "1",
        "userId": "5"
      }
    }
  }
}
```

#### Response Exitoso (200 OK):
```json
"Webhook procesado exitosamente"
```

#### Response de Error (400 Bad Request):
```json
"Error procesando webhook"
```

#### Eventos Procesados:
- `checkout.session.completed` - Pago completado exitosamente
- `checkout.session.expired` - Sesi√≥n de pago expirada
- `payment_intent.payment_failed` - Pago fall√≥

---

### 3. Health Check de Stripe
**Endpoint:** `GET /api/stripe/health`  
**Descripci√≥n:** Verifica que el servicio de Stripe est√© funcionando correctamente  
**Acceso:** P√∫blico (para monitoreo)  

#### Response Exitoso (200 OK):
```json
"Stripe service is healthy"
```

---

## üí∞ Endpoints de Payment

### 4. Crear Pago Manual
**Endpoint:** `POST /api/payments`  
**Descripci√≥n:** Crea un registro de pago manualmente (generalmente usado internamente por webhooks)  
**Acceso:** ADMIN  
**Autenticaci√≥n:** JWT Required  

#### Request Body:
```json
{
  "stripePaymentId": "pi_1234567890abcdef",
  "user": {
    "id": 5
  },
  "course": {
    "id": 1
  },
  "amount": 99.99,
  "status": "COMPLETED",
  "paymentData": "{\"method\":\"card\",\"last4\":\"4242\"}"
}
```

#### Response Exitoso (200 OK):
```json
{
  "id": 1,
  "stripePaymentId": "pi_1234567890abcdef",
  "user": {
    "id": 5,
    "userName": "Juan",
    "email": "juan@example.com"
  },
  "course": {
    "id": 1,
    "title": "Curso de Java B√°sico",
    "price": 99.99
  },
  "amount": 99.99,
  "status": "COMPLETED",
  "createdAt": "2025-01-01T10:00:00.000+00:00",
  "updatedAt": "2025-01-01T10:00:00.000+00:00",
  "paymentData": "{\"method\":\"card\",\"last4\":\"4242\"}",
  "enrollment": {
    "id": 10,
    "status": "ACTIVE"
  }
}
```

---

### 5. Obtener Pago por ID
**Endpoint:** `GET /api/payments/{id}`  
**Descripci√≥n:** Obtiene la informaci√≥n detallada de un pago espec√≠fico  
**Acceso:** ADMIN, INSTRUCTOR (propio), STUDENT (propio)  
**Autenticaci√≥n:** JWT Required  

#### Path Parameters:
- **id:** ID del pago (requerido)

#### Response Exitoso (200 OK):
```json
{
  "id": 1,
  "stripePaymentId": "pi_1234567890abcdef",
  "user": {
    "id": 5,
    "userName": "Juan",
    "email": "juan@example.com"
  },
  "course": {
    "id": 1,
    "title": "Curso de Java B√°sico",
    "price": 99.99
  },
  "amount": 99.99,
  "status": "COMPLETED",
  "createdAt": "2025-01-01T10:00:00.000+00:00",
  "updatedAt": "2025-01-01T10:00:00.000+00:00"
}
```

#### Response de Error (404 Not Found):
```json
{
  "message": "Pago no encontrado con ID: 999",
  "status": 404,
  "timestamp": "2025-01-01T10:00:00"
}
```

---

### 6. Obtener Pagos por Usuario
**Endpoint:** `GET /api/payments/user/{userId}`  
**Descripci√≥n:** Obtiene todos los pagos realizados por un usuario espec√≠fico  
**Acceso:** ADMIN, STUDENT (propio)  
**Autenticaci√≥n:** JWT Required  

#### Path Parameters:
- **userId:** ID del usuario (requerido)

#### Response Exitoso (200 OK):
```json
[
  {
    "id": 1,
    "stripePaymentId": "pi_1234567890abcdef",
    "course": {
      "id": 1,
      "title": "Curso de Java B√°sico",
      "thumbnailUrl": "https://example.com/thumb.jpg"
    },
    "amount": 99.99,
    "status": "COMPLETED",
    "createdAt": "2025-01-01T10:00:00.000+00:00"
  },
  {
    "id": 2,
    "stripePaymentId": "pi_0987654321fedcba",
    "course": {
      "id": 3,
      "title": "Curso de React Avanzado",
      "thumbnailUrl": "https://example.com/thumb2.jpg"
    },
    "amount": 149.99,
    "status": "COMPLETED",
    "createdAt": "2025-01-02T15:30:00.000+00:00"
  }
]
```

---

### 7. Obtener Pagos por Curso
**Endpoint:** `GET /api/payments/course/{courseId}`  
**Descripci√≥n:** Obtiene todos los pagos realizados para un curso espec√≠fico  
**Acceso:** ADMIN, INSTRUCTOR (propietario del curso)  
**Autenticaci√≥n:** JWT Required  

#### Path Parameters:
- **courseId:** ID del curso (requerido)

#### Response Exitoso (200 OK):
```json
[
  {
    "id": 1,
    "stripePaymentId": "pi_1234567890abcdef",
    "user": {
      "id": 5,
      "userName": "Juan",
      "email": "juan@example.com"
    },
    "amount": 99.99,
    "status": "COMPLETED",
    "createdAt": "2025-01-01T10:00:00.000+00:00"
  },
  {
    "id": 3,
    "stripePaymentId": "pi_abcdef1234567890",
    "user": {
      "id": 8,
      "userName": "Mar√≠a",
      "email": "maria@example.com"
    },
    "amount": 99.99,
    "status": "COMPLETED",
    "createdAt": "2025-01-03T09:15:00.000+00:00"
  }
]
```

---

### 8. Obtener Pagos por Estado
**Endpoint:** `GET /api/payments/status/{status}`  
**Descripci√≥n:** Obtiene todos los pagos filtrados por estado  
**Acceso:** ADMIN  
**Autenticaci√≥n:** JWT Required  

#### Path Parameters:
- **status:** Estado del pago - `PENDING`, `COMPLETED`, `REFUNDED`, `FAILED` (requerido)

#### Response Exitoso (200 OK):
```json
[
  {
    "id": 1,
    "stripePaymentId": "pi_1234567890abcdef",
    "user": {
      "id": 5,
      "userName": "Juan"
    },
    "course": {
      "id": 1,
      "title": "Curso de Java B√°sico"
    },
    "amount": 99.99,
    "status": "COMPLETED",
    "createdAt": "2025-01-01T10:00:00.000+00:00"
  }
]
```

---

## üóÇÔ∏è Endpoints de Payment Sessions

### 9. Crear Sesi√≥n de Pago Manual
**Endpoint:** `POST /api/payment-sessions`  
**Descripci√≥n:** Crea una sesi√≥n de pago manualmente (uso interno/admin)  
**Acceso:** ADMIN  
**Autenticaci√≥n:** JWT Required  

#### Request Body:
```json
{
  "stripeSessionId": "cs_test_a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0",
  "user": {
    "id": 5
  },
  "course": {
    "id": 1
  },
  "status": "CREATED",
  "sessionData": "{\"created_at\":\"2025-01-01T10:00:00Z\"}"
}
```

#### Response Exitoso (200 OK):
```json
{
  "id": 1,
  "stripeSessionId": "cs_test_a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0",
  "user": {
    "id": 5,
    "userName": "Juan"
  },
  "course": {
    "id": 1,
    "title": "Curso de Java B√°sico"
  },
  "status": "CREATED",
  "createdAt": "2025-01-01T10:00:00.000+00:00",
  "updatedAt": "2025-01-01T10:00:00.000+00:00"
}
```

---

### 10. Obtener Sesi√≥n de Pago por ID
**Endpoint:** `GET /api/payment-sessions/{id}`  
**Descripci√≥n:** Obtiene informaci√≥n de una sesi√≥n de pago espec√≠fica  
**Acceso:** ADMIN, STUDENT (propias), INSTRUCTOR (de sus cursos)  
**Autenticaci√≥n:** JWT Required  

#### Path Parameters:
- **id:** ID de la sesi√≥n de pago (requerido)

#### Response Exitoso (200 OK):
```json
{
  "id": 1,
  "stripeSessionId": "cs_test_a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0",
  "user": {
    "id": 5,
    "userName": "Juan",
    "email": "juan@example.com"
  },
  "course": {
    "id": 1,
    "title": "Curso de Java B√°sico",
    "price": 99.99
  },
  "status": "COMPLETED",
  "createdAt": "2025-01-01T10:00:00.000+00:00",
  "updatedAt": "2025-01-01T10:05:00.000+00:00",
  "payments": [
    {
      "id": 1,
      "amount": 99.99,
      "status": "COMPLETED"
    }
  ]
}
```

#### Response de Error (404 Not Found):
```json
{
  "message": "Sesi√≥n de pago no encontrada con ID: 999",
  "status": 404,
  "timestamp": "2025-01-01T10:00:00"
}
```

---

### 11. Obtener Sesiones por Usuario
**Endpoint:** `GET /api/payment-sessions/user/{userId}`  
**Descripci√≥n:** Obtiene todas las sesiones de pago de un usuario  
**Acceso:** ADMIN, STUDENT (propias)  
**Autenticaci√≥n:** JWT Required  

#### Path Parameters:
- **userId:** ID del usuario (requerido)

#### Response Exitoso (200 OK):
```json
[
  {
    "id": 1,
    "stripeSessionId": "cs_test_a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0",
    "course": {
      "id": 1,
      "title": "Curso de Java B√°sico",
      "price": 99.99
    },
    "status": "COMPLETED",
    "createdAt": "2025-01-01T10:00:00.000+00:00"
  },
  {
    "id": 2,
    "stripeSessionId": "cs_test_b2C3d4E5f6G7h8I9j0K1l2M3n4O5p6Q7r8S9t0U1",
    "course": {
      "id": 3,
      "title": "Curso de React Avanzado",
      "price": 149.99
    },
    "status": "EXPIRED",
    "createdAt": "2025-01-02T15:30:00.000+00:00"
  }
]
```

---

### 12. Obtener Sesiones por Curso
**Endpoint:** `GET /api/payment-sessions/course/{courseId}`  
**Descripci√≥n:** Obtiene todas las sesiones de pago para un curso espec√≠fico  
**Acceso:** ADMIN, INSTRUCTOR (propietario del curso)  
**Autenticaci√≥n:** JWT Required  

#### Path Parameters:
- **courseId:** ID del curso (requerido)

#### Response Exitoso (200 OK):
```json
[
  {
    "id": 1,
    "stripeSessionId": "cs_test_a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0",
    "user": {
      "id": 5,
      "userName": "Juan",
      "email": "juan@example.com"
    },
    "status": "COMPLETED",
    "createdAt": "2025-01-01T10:00:00.000+00:00"
  },
  {
    "id": 3,
    "stripeSessionId": "cs_test_c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0u1V2",
    "user": {
      "id": 8,
      "userName": "Mar√≠a",
      "email": "maria@example.com"
    },
    "status": "COMPLETED",
    "createdAt": "2025-01-03T09:15:00.000+00:00"
  }
]
```

---

### 13. Obtener Sesiones por Estado
**Endpoint:** `GET /api/payment-sessions/status/{status}`  
**Descripci√≥n:** Obtiene todas las sesiones de pago filtradas por estado  
**Acceso:** ADMIN  
**Autenticaci√≥n:** JWT Required  

#### Path Parameters:
- **status:** Estado de la sesi√≥n - `CREATED`, `COMPLETED`, `EXPIRED` (requerido)

#### Response Exitoso (200 OK):
```json
[
  {
    "id": 1,
    "stripeSessionId": "cs_test_a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0",
    "user": {
      "id": 5,
      "userName": "Juan"
    },
    "course": {
      "id": 1,
      "title": "Curso de Java B√°sico"
    },
    "status": "COMPLETED",
    "createdAt": "2025-01-01T10:00:00.000+00:00"
  }
]
```

---

## üìä Estados y Enumeraciones

### Estados de Payment:
- **PENDING:** Pago iniciado pero no completado
- **COMPLETED:** Pago completado exitosamente
- **REFUNDED:** Pago reembolsado
- **FAILED:** Pago fall√≥

### Estados de PaymentSession:
- **CREATED:** Sesi√≥n creada en Stripe
- **COMPLETED:** Sesi√≥n completada (pago exitoso)
- **EXPIRED:** Sesi√≥n expirada sin pago

---

## üîê Seguridad y Autenticaci√≥n

### Headers de Autenticaci√≥n:
```
Authorization: Bearer {jwt_token}
```

### Permisos por Rol:

#### üéì STUDENT
- ‚úÖ Crear sesiones de pago para cursos
- ‚úÖ Ver sus propios pagos y sesiones
- ‚ùå Ver pagos de otros usuarios
- ‚ùå Acceso a endpoints administrativos

#### üë®‚Äçüè´ INSTRUCTOR  
- ‚úÖ Ver pagos de sus cursos
- ‚úÖ Ver sesiones de pago de sus cursos
- ‚ùå Crear pagos manualmente
- ‚ùå Ver informaci√≥n de otros instructores

#### üë®‚Äçüíº ADMIN
- ‚úÖ Acceso completo a todos los endpoints
- ‚úÖ Crear pagos manualmente
- ‚úÖ Ver estad√≠sticas y reportes
- ‚úÖ Gestionar reembolsos

---

## üöÄ Implementaci√≥n Frontend

### Ejemplo de Flujo Completo:

#### 1. Crear sesi√≥n de pago:
```javascript
const createPaymentSession = async (courseId, userId) => {
  try {
    const response = await fetch('/api/stripe/create-checkout-session', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${jwt_token}`
      },
      body: JSON.stringify({
        courseId: courseId,
        userId: userId,
        successUrl: `${window.location.origin}/payment/success`,
        cancelUrl: `${window.location.origin}/payment/cancel`
      })
    });
    
    const data = await response.json();
    
    if (data.checkoutUrl) {
      // Redirigir a Stripe Checkout
      window.location.href = data.checkoutUrl;
    }
  } catch (error) {
    console.error('Error creating payment session:', error);
  }
};
```

#### 2. Verificar estado de pago:
```javascript
const checkPaymentStatus = async (userId) => {
  try {
    const response = await fetch(`/api/payments/user/${userId}`, {
      headers: {
        'Authorization': `Bearer ${jwt_token}`
      }
    });
    
    const payments = await response.json();
    return payments.filter(payment => payment.status === 'COMPLETED');
  } catch (error) {
    console.error('Error checking payment status:', error);
  }
};
```

#### 3. Obtener historial de pagos:
```javascript
const getUserPaymentHistory = async (userId) => {
  try {
    const response = await fetch(`/api/payments/user/${userId}`, {
      headers: {
        'Authorization': `Bearer ${jwt_token}`
      }
    });
    
    const payments = await response.json();
    
    // Ordenar por fecha descendente
    return payments.sort((a, b) => 
      new Date(b.createdAt) - new Date(a.createdAt)
    );
  } catch (error) {
    console.error('Error fetching payment history:', error);
  }
};
```

---

## ‚ö†Ô∏è Consideraciones Importantes

### Variables de Entorno Requeridas:
```env
STRIPE_API_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

### URLs de Redirecci√≥n:
- **Success URL:** P√°gina de confirmaci√≥n despu√©s del pago exitoso
- **Cancel URL:** P√°gina cuando el usuario cancela el pago
- **Webhook URL:** `https://tu-dominio.com/api/stripe/webhook`

### Testing:
- Usar las tarjetas de prueba de Stripe: `4242 4242 4242 4242`
- Las claves deben empezar con `sk_test_` en desarrollo
- Configurar webhooks en el dashboard de Stripe

### Producci√≥n:
- Cambiar a claves de producci√≥n: `sk_live_`
- Configurar HTTPS obligatorio
- Implementar rate limiting
- Configurar logging de transacciones
- Backup de base de datos antes de procesar reembolsos

---

## üìû Soporte

Para dudas sobre la implementaci√≥n:
- üìß Email: dev-team@elearning-platform.com
- üìö Documentaci√≥n Stripe: https://stripe.com/docs/api
- üîß Testing: Usar `stripe_checkout_test.sh` para pruebas automatizadas